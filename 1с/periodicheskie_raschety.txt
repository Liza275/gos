&НаКлиенте
Процедура Рассчитать(Команда)
 
 РассчитатьНаСервере();
 
 НДФЛРассчитать();

 
КонецПроцедуры 

&НаСервере
Процедура НДФЛРассчитать()
 
 Запрос = Новый Запрос;
 Запрос.Текст = 
  "ВЫБРАТЬ
  | ВТ_Начисления.Сотрудник КАК Сотрудник,
  | ВТ_Начисления.Начислено КАК Начислено
  |ПОМЕСТИТЬ вт
  |ИЗ
  | &Начисления КАК ВТ_Начисления
  |;
  |
  |////////////////////////////////////////////////////////////////////////////////
  |ВЫБРАТЬ
  | вт.Сотрудник КАК Сотрудник,
  | СУММА(вт.Начислено) КАК Начислено,
  | 0 КАК Удержано
  |ИЗ
  | вт КАК вт
  |
  |СГРУППИРОВАТЬ ПО
  | вт.Сотрудник";
 Запрос.УстановитьПараметр("Начисления",Объект.Начисления.Выгрузить());
 
 РезультатЗапроса = Запрос.Выполнить();
 
 ТЗ = РезультатЗапроса.Выгрузить();
 Для Каждого Стр Из ТЗ Цикл
  Стр.Удержано = (Стр.Начислено / 100 * 13);  
 КонецЦикла;
 ТЗ.Колонки.Удалить("Начислено");
 
 Объект.НДФЛ.Загрузить(ТЗ);

 
КонецПроцедуры

&НаСервере
Процедура РассчитатьНаСервере()

Для Каждого Стр Из Объект.Начисления Цикл
 
 Если ЗначениеЗаполнено(Стр.ВидРасчета) И (Стр.ВидРасчета = ПланыВидовРасчета.Основной.Оклад) Тогда
   
 Запрос = Новый Запрос;
 Запрос.Текст = 
  "ВЫБРАТЬ
  | ЗарплатаДанныеГрафика.ЗначениеПериодДействия КАК ВсегоРабочихДней,
  | ЗарплатаДанныеГрафика.ЗначениеФактическийПериодДействия КАК КолВоДнейНевыхода
  |ИЗ
  | РегистрРасчета.Зарплата.ДанныеГрафика(
  |   Сотрудник = &Сотрудник
  |    И ВидРасчета = &Невыход
  |    И ПериодДействия = &Дата) КАК ЗарплатаДанныеГрафика";
 
 Запрос.УстановитьПараметр("Дата", НачалоМесяца(Объект.Дата));
 Запрос.УстановитьПараметр("Невыход", ПланыВидовРасчета.Основной.Невыход);
 Запрос.УстановитьПараметр("Сотрудник",Стр.Сотрудник);
 
 РезультатЗапроса = Запрос.Выполнить();
 
 ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
 Если ВыборкаДетальныеЗаписи.Следующий() Тогда 
  суммадень = 5000 / ВыборкаДетальныеЗаписи.ВсегоРабочихДней;
  фактработал = ВыборкаДетальныеЗаписи.ВсегоРабочихДней - ВыборкаДетальныеЗаписи.КолВоДнейНевыхода;
  Стр.Начислено = суммадень * фактработал; 
  Стр.ИсходныеДанные = "Полный оклад 5000, Кол-во рабочих дней: " + ВыборкаДетальныеЗаписи.ВсегоРабочихДней + ", Факт работал: " + фактработал + 
  ", Сумма за день: " + суммадень;
 Иначе
  Стр.Начислено = 5000;
  Стр.ИсходныеДанные = "Полный оклад 5000";
 КонецЕсли;
 
  
 КонецЕсли;
 
 Если ЗначениеЗаполнено(Стр.ВидРасчета) И (Стр.ВидРасчета = ПланыВидовРасчета.Основной.Премия) Тогда
  
 Запрос = Новый Запрос;
 Запрос.Текст = 
  "ВЫБРАТЬ
  | СделкиРаботниковОбороты.СуммаСделкиОборот КАК ИтоговаяСуммаСделки
  |ИЗ
  | РегистрНакопления.СделкиРаботников.Обороты(&НП, &КП, , Сотрудник = &Сотрудник) КАК СделкиРаботниковОбороты";
 
 Запрос.УстановитьПараметр("КП", Стр.ДатаОкончания);
 Запрос.УстановитьПараметр("НП", Стр.ДатаНачала);
 Запрос.УстановитьПараметр("Сотрудник", Стр.Сотрудник);
 
 РезультатЗапроса = Запрос.Выполнить();
 
 ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
 Если ВыборкаДетальныеЗаписи.Следующий() Тогда
  Если ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки > 400000 Тогда
   Стр.Начислено = ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки / 100 * 10;
   Стр.ИсходныеДанные = "Итоговая сумма = " + ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки + ", процент = 10";
   Продолжить;
  КонецЕсли;
  Если ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки > 200000 Тогда
   Стр.Начислено = ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки / 100 * 7;
   Стр.ИсходныеДанные = "Итоговая сумма = " + ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки + ", процент = 7";
   Продолжить;
  КонецЕсли;
  Стр.Начислено = ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки / 100 * 5;
  Стр.ИсходныеДанные = "Итоговая сумма = " + ВыборкаДетальныеЗаписи.ИтоговаяСуммаСделки + ", процент = 5";
  КонецЕсли;
 КонецЕсли; 
 
КонецЦикла;

КонецПроцедуры

//Все что ниже, добавлять в Модуль объекта

Процедура ОбработкаПроведения(Отказ, Режим)

 // регистр Зарплата
 Движения.Зарплата.Записывать = Истина;
 Для Каждого ТекСтрокаНачисления Из Начисления Цикл
  Движение = Движения.Зарплата.Добавить();
  Движение.Сторно = Ложь;
  Движение.ВидРасчета = ТекСтрокаНачисления.ВидРасчета;
  Движение.ПериодДействияНачало = ТекСтрокаНачисления.ДатаНачала;
  Движение.ПериодДействияКонец = ТекСтрокаНачисления.ДатаОкончания;
  Движение.ПериодРегистрации = НачалоМесяца(Дата);
  Движение.БазовыйПериодНачало = ТекСтрокаНачисления.ДатаНачала;
  Движение.БазовыйПериодКонец = ТекСтрокаНачисления.ДатаОкончания;
  Движение.Сотрудник = ТекСтрокаНачисления.Сотрудник;
  Движение.Результат = ТекСтрокаНачисления.Начислено;
  Движение.ИсходныеДанные = 0;
 КонецЦикла;

 // регистр Удержания
 Движения.Удержания.Записывать = Истина;
 Для Каждого ТекСтрокаНДФЛ Из НДФЛ Цикл
  Движение = Движения.Удержания.Добавить();
  Движение.Сторно = Ложь;
  Движение.ВидРасчета = ПланыВидовРасчета.Удержания.НДФЛ;
  Движение.ПериодРегистрации = Дата;
  Движение.Сотрудник = ТекСтрокаНДФЛ.Сотрудник;
  Движение.Результат = ТекСтрокаНДФЛ.Удержано;
 КонецЦикла;

КонецПроцедуры