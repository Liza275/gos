&НаКлиенте
Процедура Рассчитать(Команда)
 
 Рассчитатьнасервере();
 
КонецПроцедуры            

&НаСервере
Процедура рассчитатьнасервере()
 
 Для Каждого Стр Из Объект.Продажа Цикл
  стр.Скидка = ПолучитьСкидку(Стр.Товар);  
 КонецЦикла;
 
 РассчитатьЦены();
 РассчитатьИтого();
 
КонецПроцедуры 

&НаСервере
Процедура РассчитатьИтого()
 
Для Каждого Стр Из Объект.Продажа Цикл
 Стр.Итого = Стр.Количество * (Стр.Цена*(100-Стр.Скидка)/100); 
КонецЦикла;
 
КонецПроцедуры

&НаСервере
Функция ПолучитьСкидку(Товар)
  
 Запрос = Новый Запрос;
 Запрос.Текст = 
  "ВЫБРАТЬ
  | УправленческийОборотыДтКт.СуммаОборот КАК СуммаОборот,
  | УправленческийОборотыДтКт.СубконтоДт1 КАК СубконтоДт1
  |ИЗ
  | РегистрБухгалтерии.Управленческий.ОборотыДтКт(&началопериода, &конецпериода, , СчетДТ = &счетдт, , СчетКТ = &счеткт, , СубконтоДт1 = &Товар) КАК УправленческийОборотыДтКт";
 
 Запрос.УстановитьПараметр("конецпериода", КонецМесяца(ДобавитьМесяц(Объект.Дата,-1)));
 Запрос.УстановитьПараметр("началопериода", НачалоМесяца(ДобавитьМесяц(Объект.Дата,-1)));;
 Запрос.УстановитьПараметр("счетдт", ПланыСчетов.Основной.Товары);
 Запрос.УстановитьПараметр("счеткт", ПланыСчетов.Основной.РасчетыСПоставщиками);
 Запрос.УстановитьПараметр("товар", товар);
 
 РезультатЗапроса = Запрос.Выполнить();
 
 ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
 Если ВыборкаДетальныеЗаписи.Следующий() Тогда
  
  Если ВыборкаДетальныеЗаписи.СуммаОборот > 1000 И ВыборкаДетальныеЗаписи.СуммаОборот < 3000 Тогда
         Возврат 2; 
  КонецЕсли;  
  
  Если ВыборкаДетальныеЗаписи.СуммаОборот > 3000 И ВыборкаДетальныеЗаписи.СуммаОборот < 5000 Тогда
         Возврат 5; 
  КонецЕсли;
  
  Если ВыборкаДетальныеЗаписи.СуммаОборот > 5000 И ВыборкаДетальныеЗаписи.СуммаОборот < 10000 Тогда
         Возврат 10; 
  КонецЕсли;
  
  Если ВыборкаДетальныеЗаписи.СуммаОборот > 10000 Тогда
         Возврат 15; 
  КонецЕсли;
  
  Возврат 0;
  
 Иначе
  Возврат 0;  
 Конецесли;
 
КонецФункции

&НаСервере
Процедура РассчитатьЦены()
 
 запрос = новый запрос;
 запрос.Текст = "ВЫБРАТЬ
                | РозничныеЦеныСрезПоследних.Цена КАК Цена
                |ИЗ
                | РегистрСведений.РозничныеЦены.СрезПоследних(&дата, ) КАК РозничныеЦеныСрезПоследних
                |ГДЕ
                | РозничныеЦеныСрезПоследних.Товар = &Товар";               
 запрос.УстановитьПараметр("дата",Объект.Дата);
 
 Для Каждого Стр Из Объект.Продажа Цикл
  стр.цена = ПолучитьЦеныТоваров(Стр.товар,запрос); 
 КонецЦикла;
 
КонецПроцедуры 

&НаСервере
Функция ПолучитьЦеныТоваров(товар,запрос)
 запрос.УстановитьПараметр("товар",товар);
 выборка = запрос.выполнить().выбрать();
 если выборка.следующий() тогда
  возврат выборка.цена;  
 иначе
  возврат неопределено; 
 конецесли;
КонецФункции 

//Все что ниже, добавлять в Модуль Объекта!!!!!!!!!!!!!!!!!!!!!!!

Процедура ОбработкаПроведения(Отказ, Режим)
 
 запрос = новый запрос;
 запрос.Текст = "ВЫБРАТЬ
                | РозничныеЦеныСрезПоследних.Цена КАК Цена
                |ИЗ
                | РегистрСведений.РозничныеЦены.СрезПоследних(&дата, ) КАК РозничныеЦеныСрезПоследних
                |ГДЕ
                | РозничныеЦеныСрезПоследних.Товар = &Товар";               
 запрос.УстановитьПараметр("дата",КонецМесяца(ДобавитьМесяц(Дата,-1)));  
 
 // регистр Управленческий 
 Движения.Управленческий.Записывать = Истина;
 Для Каждого ТекСтрокаПродажа Из Продажа Цикл
  Движение = Движения.Управленческий.Добавить();
  Движение.СчетДт = ПланыСчетов.Основной.Капитал;
  Движение.СчетКт = ПланыСчетов.Основной.Товары;
  Движение.Период = Дата;

  запрос.УстановитьПараметр("товар",ТекСтрокаПродажа.товар);
 выборка = запрос.выполнить().выбрать();
 если выборка.следующий() тогда              
   Движение.Сумма = выборка.цена * ТекСтрокаПродажа.Количество;
 иначе 
  Движение.Сумма = ТекСтрокаПродажа.Итого;   
 конецесли;  
  
  Движение.Количество = ТекСтрокаПродажа.Количество;
  Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Товары] = ТекСтрокаПродажа.Товар;
 КонецЦикла;

 // регистр Управленческий 
 Движения.Управленческий.Записывать = Истина;
 Для Каждого ТекСтрокаПродажа Из Продажа Цикл
  Движение = Движения.Управленческий.Добавить();
  Движение.СчетДт = ПланыСчетов.Основной.ДебиторскаяЗадолженность;
  Движение.СчетКт = ПланыСчетов.Основной.Капитал;
  Движение.Период = Дата;
  Движение.Сумма = ТекСтрокаПродажа.Итого;
  Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Клиенты] = Клиент;
  Движение.СписочнаяЦена = ТекСтрокаПродажа.Цена * ТекСтрокаПродажа.Количество;
  Движение.Скидка = ТекСтрокаПродажа.Скидка;
 КонецЦикла;

КонецПроцедуры
