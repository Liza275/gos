&НаКлиенте
Процедура РасходТоваровНоменклатураПриИзменении(Элемент)
 
 ТД = Элементы.РасходТоваров.ТекущиеДанные;
 Если ЗначениеЗаполнено(ТД.Номенклатура) Тогда
  ТД.Цена = ПолучитьСебестоимость(ТД.Номенклатура); 
 КонецЕсли; 
 
 ПересчитатьИтоговуюСумму(Элементы.РасходТоваров.ТекущиеДанные);
 
КонецПроцедуры 

&НаКлиенте
Процедура РасходТоваровКоличествоПриИзменении(Элемент)

 ТД = Элементы.РасходТоваров.ТекущиеДанные;
 Если ЗначениеЗаполнено(ТД.Номенклатура) Тогда
  ТД.Цена = ПолучитьСебестоимость(ТД.Номенклатура); 
 КонецЕсли; 
 
 ПересчитатьИтоговуюСумму(Элементы.РасходТоваров.ТекущиеДанные);
 
КонецПроцедуры

&НаСервере
Функция ПолучитьСебестоимость(Номеклатура)
 
 Запрос = Новый Запрос;
 Запрос.Текст = "ВЫБРАТЬ
                | ОстаткиТоваровНаСкладахОбороты.Номенклатура КАК Номенклатура,
                | ОстаткиТоваровНаСкладахОбороты.ИтоговаяСуммаПриход / ОстаткиТоваровНаСкладахОбороты.КоличествоПриход КАК Себестоимость
                |ИЗ
                | РегистрНакопления.ОстаткиТоваровНаСкладах.Обороты КАК ОстаткиТоваровНаСкладахОбороты
                |ГДЕ
                | ОстаткиТоваровНаСкладахОбороты.Номенклатура = &Номенклатура";
 Запрос.УстановитьПараметр("Номенклатура",Номеклатура);
 
 РЗ = Запрос.Выполнить();
 Выборка = РЗ.Выбрать();
 Если Выборка.Следующий() Тогда
  Возврат Выборка.Себестоимость; 
 КонецЕсли;
 
КонецФункции 

&НаКлиенте
Процедура ПересчитатьИтоговуюСумму(ТекущиеДанные)

 ТекущиеДанные.ИтоговаяСумма = ТекущиеДанные.Цена * ТекущиеДанные.Количество + ТекущиеДанные.СтоимостьДопУслуг ;  
 
КонецПроцедуры

&НаКлиенте
Процедура РасходУслугНоменклатураПриИзменении(Элемент)
 
 СтрУс = Элементы.РасходУслуг.ТекущиеДанные;
 ПересчитатьДопСуммуУслуг(СтрУс); 
 
КонецПроцедуры

&НаКлиенте
Процедура Пересчитать(Команда)
 
 ОчиститьСуммуДопУслуг();
 Для Каждого СтрУс Из Объект.РасходУслуг Цикл 
  ПересчитатьДопСуммуУслуг(СтрУс); 
 КонецЦикла;
 ПересчитатьРасходТоваров();
 
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьДопСуммуУслуг(СтрУс)

 ИтогПоЦене = Объект.РасходТоваров.Итог("Цена");
 Для Каждого Стр Из Объект.РасходТоваров Цикл
  
  ДоляПроцентаОтИтогЦены = Стр.Цена * 100 / ИтогПоЦене;
  Стр.СтоимостьДопУслуг = Стр.СтоимостьДопУслуг + (СтрУс.Цена * ДоляПроцентаОтИтогЦены / 100);
  
 КонецЦикла; 

КонецПроцедуры 

&НаКлиенте
Процедура ПересчитатьРасходТоваров()

 Для Каждого СтрТов Из Объект.РасходТоваров Цикл
  СтрТов.ИтоговаяСумма = СтрТов.Цена * СтрТов.Количество + СтрТов.СтоимостьДопУслуг ;    
 КонецЦикла;
 
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьСуммуДопУслуг()
 
 Для Каждого СтрТов Из Объект.РасходТоваров Цикл
  СтрТов.СтоимостьДопУслуг = 0;    
 КонецЦикла;
 
КонецПроцедуры


